# backend-pfs-topup/nixpacks.toml
[phases.setup]
nixPkgs = [
  'php82',
  'php82Extensions.pdo_mysql',
  'php82Extensions.mbstring',
  'php82Extensions.gd',
  'php82Extensions.curl',
  'php82Extensions.bcmath',
  'php82Extensions.zip',
  'php82Extensions.exif'      # tambahan biar upload gambar aman
]

[phases.install]
cmds = ['composer install --no-dev --optimize-autoloader --no-interaction']

# Build phase: hanya bersihin cache (tidak perlu migrate di sini)
[phases.build]
cmds = [
  'php artisan config:clear',
  'php artisan route:clear',
  'php artisan view:clear',
  'php artisan cache:clear'
]

# Deploy phase: WAJIB migrate & storage:link DI SINI
[phases.deploy]
cmds = [
  'php artisan storage:link || true',                    # symlink storage
  'php artisan migrate --force --no-interaction',        # ini yang paling krusial
  'php artisan config:cache',
  'php artisan route:cache',
  'php artisan view:cache',
  'php artisan optimize'                                 # bonus speed
]

# Start command â€” paling stabil & Railway suka banget
[start]
cmd = "php artisan serve --host=0.0.0.0 --port=${PORT} --tries=3 --no-interaction"
